<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pumpki â€” Your Breathing Buddy</title>
    <meta name="theme-color" content="#C4956A">
    <meta name="description" content="Beautiful, neurodivergent-friendly companion for breathing exercises and self-regulation with cute brain science tips. Research-informed tool for nervous system awareness.">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="icon" href="hot.png">
    
    <style>
        :root {
            /* Refined warm palette â€” matching Her Own Terms */
            --primary: #C4956A;
            --primary-light: #D4A87E;
            --primary-dark: #A67B52;
            --primary-deep: #8B6543;
            --warm-amber: #D8B888;
            --terracotta: #B86B4A;
            
            /* Dark backgrounds with warm undertones */
            --bg-primary: #1A1512;
            --bg-secondary: rgba(38, 30, 24, 0.95);
            --bg-tertiary: rgba(196, 149, 106, 0.06);
            --bg-card: rgba(255, 255, 255, 0.04);
            --bg-elevated: rgba(255, 255, 255, 0.06);
            
            /* Earthy accents */
            --sage: #7A8F65;
            --sage-light: #8FA576;
            --slate: #7A8F9D;
            --mauve: #9E8A94;
            --gold: #C4A855;
            --coral: #C46A5A;
            
            /* Text */
            --text-primary: #F0E4D8;
            --text-secondary: #C4B09C;
            --text-tertiary: #8A7E72;
            
            /* Status */
            --success: #8FAD6F;
            --warning: #C49850;
            --error: #B85A42;
            
            /* Borders & surfaces */
            --border: rgba(196, 149, 106, 0.15);
            --border-active: rgba(196, 149, 106, 0.4);
            
            /* Typography */
            --serif: 'Cormorant Garamond', Georgia, serif;
            --sans: 'DM Sans', -apple-system, sans-serif;
            
            /* Radii */
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* Shadows */
            --shadow-sm: 0 2px 12px rgba(0,0,0,0.15);
            --shadow-md: 0 4px 24px rgba(0,0,0,0.2);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.25);
            --shadow-glow: 0 0 24px rgba(196, 149, 106, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--sans);
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.65;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        body.high-contrast {
            --bg-primary: #000;
            --text-primary: #fff;
            --primary: #FF8C4A;
        }

        .hidden { display: none !important; }

        /* â”€â”€â”€ Main Layout â”€â”€â”€ */
        #main-content {
            max-width: 960px;
            margin: 0 auto;
            padding: 32px 24px 120px;
        }

        /* â”€â”€â”€ Header â”€â”€â”€ */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 32px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .title {
            font-family: var(--serif);
            font-size: clamp(28px, 4vw, 38px);
            font-weight: 400;
            letter-spacing: -0.02em;
            color: var(--primary);
        }

        .title .pumpki-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }

        .title .pumpki-icon svg {
            width: 20px;
            height: 20px;
            fill: var(--bg-primary);
        }

        /* â”€â”€â”€ Controls â”€â”€â”€ */
        .accessibility-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-family: var(--sans);
            font-size: 13px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
        }

        .control-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .control-btn.active {
            background: var(--primary);
            color: var(--bg-primary);
            border-color: var(--primary);
        }

        /* â”€â”€â”€ Disclaimer â”€â”€â”€ */
        .disclaimer-bar {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 16px 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-left: 3px solid var(--mauve);
            border-radius: var(--radius);
            margin-bottom: 28px;
        }

        .disclaimer-bar .icon-wrap {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            background: rgba(158, 138, 148, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .disclaimer-bar .icon-wrap svg {
            width: 14px;
            height: 14px;
            stroke: var(--mauve);
            fill: none;
            stroke-width: 2;
        }

        .disclaimer-bar p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .disclaimer-bar strong {
            color: var(--text-primary);
        }

        /* â”€â”€â”€ Arousal Check â”€â”€â”€ */
        .arousal-check {
            text-align: center;
            margin-bottom: 28px;
        }

        .arousal-check h3 {
            font-family: var(--serif);
            font-size: 24px;
            font-weight: 400;
            color: var(--text-primary);
            margin-bottom: 20px;
            letter-spacing: -0.01em;
        }

        .arousal-scale {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            flex-wrap: wrap;
        }

        .arousal-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 16px 14px;
            border-radius: var(--radius);
            transition: all 0.3s ease;
            min-width: 80px;
            border: 1px solid transparent;
            background: var(--bg-tertiary);
        }

        .arousal-option:hover {
            border-color: var(--border-active);
            transform: translateY(-2px);
        }

        .arousal-option.selected {
            background: var(--primary);
            border-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .arousal-option.selected .arousal-label {
            color: var(--bg-primary);
        }

        .arousal-emoji { font-size: 28px; margin-bottom: 8px; }

        .arousal-label {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.02em;
            color: var(--text-secondary);
        }

        .brain-fact-inline {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            padding: 10px 18px;
            background: rgba(196, 168, 85, 0.1);
            border: 1px solid rgba(196, 168, 85, 0.2);
            border-radius: 100px;
            font-size: 13px;
            color: var(--gold);
            font-weight: 500;
        }

        .brain-fact-inline svg {
            width: 16px;
            height: 16px;
            stroke: var(--gold);
            fill: none;
            stroke-width: 2;
        }

        /* â”€â”€â”€ Navigation Tabs â”€â”€â”€ */
        .nav-tabs {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 6px;
            margin-bottom: 24px;
            gap: 4px;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            min-width: 110px;
            padding: 12px 16px;
            border: none;
            border-radius: var(--radius);
            background: transparent;
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: var(--sans);
            font-weight: 500;
            font-size: 14px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-tab svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .nav-tab.active {
            background: var(--primary);
            color: var(--bg-primary);
        }

        .nav-tab:hover:not(.active) {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .nav-tab[data-tab="emergency"] {
            color: var(--coral);
        }

        .nav-tab[data-tab="emergency"].active {
            background: var(--error);
            color: var(--text-primary);
        }

        /* â”€â”€â”€ Tab Content Cards â”€â”€â”€ */
        .tab-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 36px;
            margin-bottom: 20px;
            position: relative;
        }

        .tab-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 24px;
            right: 24px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }

        /* â”€â”€â”€ Canvas â”€â”€â”€ */
        .canvas-container {
            display: flex;
            justify-content: center;
            padding: 24px 0;
            min-height: 420px;
        }

        #pumpki-canvas {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-lg);
        }

        /* â”€â”€â”€ Breathing Controls â”€â”€â”€ */
        .breathing-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 28px;
            margin-top: 24px;
        }

        .breathing-timer {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 28px 40px;
            border-radius: var(--radius-lg);
            text-align: center;
            min-width: 280px;
        }

        .breathing-phase {
            font-family: var(--serif);
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 12px;
            min-height: 24px;
            color: var(--primary);
        }

        #timer-display {
            font-family: var(--serif);
            font-size: 40px;
            font-weight: 500;
            color: var(--primary-light);
        }

        .breathing-patterns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            width: 100%;
            margin-top: 8px;
        }

        .breathing-pattern {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .breathing-pattern::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .breathing-pattern:hover {
            border-color: var(--border-active);
            transform: translateY(-2px);
        }

        .breathing-pattern:hover::after,
        .breathing-pattern.active::after {
            transform: scaleX(1);
        }

        .breathing-pattern.active {
            border-color: var(--primary);
            background: rgba(196, 149, 106, 0.08);
        }

        .breathing-pattern .pattern-icon {
            width: 36px;
            height: 36px;
            margin: 0 auto 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .breathing-pattern .pattern-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--primary);
            fill: none;
            stroke-width: 1.8;
            stroke-linecap: round;
        }

        .breathing-pattern h4 {
            font-family: var(--serif);
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 18px;
            font-weight: 500;
        }

        .breathing-pattern p {
            font-weight: 600;
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .breathing-pattern small {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        /* â”€â”€â”€ Buttons â”€â”€â”€ */
        .primary-btn, .secondary-btn {
            padding: 12px 28px;
            border: none;
            border-radius: var(--radius);
            font-family: var(--sans);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s ease;
            min-width: 160px;
            letter-spacing: 0.01em;
        }

        .primary-btn {
            background: var(--primary);
            color: var(--bg-primary);
            border: 1px solid var(--primary-dark);
        }

        .primary-btn:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .primary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-btn {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .secondary-btn:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        /* â”€â”€â”€ Brain Tips â”€â”€â”€ */
        .brain-tip {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-left: 3px solid var(--mauve);
            border-radius: var(--radius);
            padding: 20px 24px;
            margin: 24px 0;
        }

        .brain-tip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .brain-tip-icon {
            width: 28px;
            height: 28px;
            background: rgba(158, 138, 148, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brain-tip-icon svg {
            width: 14px;
            height: 14px;
            stroke: var(--mauve);
            fill: none;
            stroke-width: 2;
        }

        .brain-tip-title {
            font-family: var(--serif);
            font-size: 17px;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
        }

        .brain-tip-content {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.65;
        }

        .brain-tip.mini {
            padding: 16px 20px;
            margin: 16px 0;
        }

        .brain-tip.mini .brain-tip-title { font-size: 15px; }
        .brain-tip.mini .brain-tip-content { font-size: 13px; }

        /* â”€â”€â”€ Fun fact â”€â”€â”€ */
        .fun-fact {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(196, 168, 85, 0.1);
            border: 1px solid rgba(196, 168, 85, 0.2);
            border-radius: 100px;
            font-size: 13px;
            color: var(--gold);
            font-weight: 500;
            margin: 16px 0;
        }

        .fun-fact svg {
            width: 14px;
            height: 14px;
            stroke: var(--gold);
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }

        /* â”€â”€â”€ Body Scan â”€â”€â”€ */
        .body-scan-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .body-scan-container h3 {
            font-family: var(--serif);
            font-size: 24px;
            font-weight: 400;
        }

        .body-outline-container {
            max-width: 240px;
            margin: 0 auto;
            padding: 24px;
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .body-part {
            cursor: pointer;
            transition: all 0.25s ease;
            stroke-width: 2;
            stroke: var(--text-tertiary);
        }

        .body-part:hover { stroke-width: 3; }
        .body-part.comfortable { fill: var(--success); stroke: #6E9555; }
        .body-part.tense { fill: var(--error); stroke: #9A4835; }
        .body-part.neutral { fill: var(--slate); stroke: #66788A; }
        .body-part.active { stroke: var(--primary); stroke-width: 4; }

        .body-legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        /* â”€â”€â”€ Sensations â”€â”€â”€ */
        .sensations-tracker {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 28px;
            border-radius: var(--radius-lg);
            text-align: center;
            width: 100%;
            max-width: 640px;
        }

        .sensations-tracker h4 {
            font-family: var(--serif);
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .sensation-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .sensation-tag {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            font-family: var(--sans);
        }

        .sensation-tag:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .sensation-tag.selected {
            background: var(--primary);
            color: var(--bg-primary);
            border-color: var(--primary-dark);
        }

        /* â”€â”€â”€ Guided Scan â”€â”€â”€ */
        .guided-scan-area {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 28px;
            border-radius: var(--radius-lg);
            text-align: center;
            width: 100%;
            max-width: 560px;
        }

        .scan-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .scan-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .scan-instruction {
            font-size: 16px;
            color: var(--text-primary);
            margin: 20px 0;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
        }

        /* â”€â”€â”€ Stats â”€â”€â”€ */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 24px 20px;
            border-radius: var(--radius);
            text-align: center;
            transition: all 0.25s ease;
        }

        .stat-card:hover { transform: translateY(-2px); }

        .stat-number {
            font-family: var(--serif);
            font-size: 40px;
            font-weight: 500;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        /* â”€â”€â”€ Mood Chart â”€â”€â”€ */
        .mood-chart-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 28px;
            border-radius: var(--radius-lg);
            margin-bottom: 32px;
            text-align: center;
        }

        .mood-chart-container h4 {
            font-family: var(--serif);
            font-size: 18px;
            font-weight: 500;
        }

        .mood-chart {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .mood-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 10px;
            border-radius: var(--radius);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            min-width: 60px;
        }

        .mood-emoji { font-size: 24px; margin-bottom: 6px; }
        .mood-date { font-size: 11px; color: var(--text-tertiary); font-weight: 500; }

        /* â”€â”€â”€ Entries â”€â”€â”€ */
        .recent-entries {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 28px;
            border-radius: var(--radius-lg);
            margin-bottom: 32px;
        }

        .entries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .entries-header h4 {
            font-family: var(--serif);
            font-size: 18px;
            font-weight: 500;
            margin: 0;
        }

        .entry-filters { display: flex; gap: 6px; flex-wrap: wrap; }

        .filter-btn {
            padding: 6px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: transparent;
            cursor: pointer;
            font-family: var(--sans);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .filter-btn:hover { border-color: var(--primary); }

        .filter-btn.active {
            background: var(--primary);
            color: var(--bg-primary);
            border-color: var(--primary);
        }

        .entries-list {
            max-height: 360px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .entry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            border-left: 3px solid var(--primary);
            transition: all 0.2s ease;
        }

        .entry-item:hover { background: var(--bg-elevated); }

        .entry-content { flex: 1; }
        .entry-type { font-size: 16px; margin-right: 8px; }
        .entry-title { font-weight: 500; font-size: 14px; margin-bottom: 3px; }
        .entry-details { font-size: 13px; color: var(--text-secondary); }
        .entry-time { font-size: 11px; color: var(--text-tertiary); text-align: right; min-width: 90px; }

        .entry-actions { display: flex; gap: 6px; margin-left: 12px; }

        .entry-action-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 11px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .entry-action-btn:hover {
            background: var(--error);
            color: var(--text-primary);
            border-color: var(--error);
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            stroke: var(--text-tertiary);
            fill: none;
            stroke-width: 1.5;
        }

        /* â”€â”€â”€ Emergency â”€â”€â”€ */
        .emergency-notice {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 20px 24px;
            background: rgba(184, 90, 66, 0.1);
            border: 1px solid rgba(184, 90, 66, 0.3);
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .emergency-notice .icon-wrap {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            background: rgba(184, 90, 66, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emergency-notice .icon-wrap svg {
            width: 16px;
            height: 16px;
            stroke: var(--coral);
            fill: none;
            stroke-width: 2;
        }

        .emergency-notice h3 {
            font-family: var(--serif);
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .emergency-notice p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .emergency-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .emergency-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-family: var(--sans);
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .emergency-btn svg {
            width: 18px;
            height: 18px;
            stroke: var(--primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            flex-shrink: 0;
        }

        .emergency-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .remember-list {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 28px;
            border-radius: var(--radius-lg);
            margin-top: 20px;
        }

        .remember-list h4 {
            font-family: var(--serif);
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .remember-list ul {
            list-style: none;
            padding: 0;
        }

        .remember-list li {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .remember-list li svg {
            width: 16px;
            height: 16px;
            stroke: var(--primary);
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }

        /* â”€â”€â”€ Scan Results â”€â”€â”€ */
        #scan-results {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 16px;
        }

        #scan-results h4 {
            font-family: var(--serif);
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        /* â”€â”€â”€ Data Management â”€â”€â”€ */
        .data-management {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 28px;
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .data-management h4 {
            font-family: var(--serif);
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .data-management p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 16px;
        }

        /* â”€â”€â”€ Legal Modal â”€â”€â”€ */
        .legal-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(26, 21, 18, 0.95);
            backdrop-filter: blur(8px);
            z-index: 1000;
            overflow-y: auto;
            padding: 40px 20px;
        }

        .legal-modal.active { display: block; }

        .legal-modal-content {
            max-width: 640px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 40px;
            position: relative;
        }

        .legal-modal-close {
            position: absolute;
            top: 16px; right: 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 32px; height: 32px;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legal-modal-close:hover {
            background: var(--primary);
            color: var(--bg-primary);
            border-color: var(--primary);
        }

        .legal-modal h2 {
            font-family: var(--serif);
            font-size: 28px;
            font-weight: 400;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .legal-modal h3 {
            font-family: var(--serif);
            font-size: 19px;
            font-weight: 500;
            margin-top: 28px;
            margin-bottom: 12px;
        }

        .legal-modal p, .legal-modal ul {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 14px;
            font-size: 14px;
        }

        .legal-modal ul { padding-left: 20px; }
        .legal-modal li { margin-bottom: 6px; }
        .legal-modal strong { color: var(--text-primary); }

        /* â”€â”€â”€ Footer â”€â”€â”€ */
        footer {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: rgba(26, 21, 18, 0.95);
            backdrop-filter: blur(16px);
            text-align: center;
            z-index: 100;
        }

        .footer-company {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .footer-tagline {
            font-size: 11px;
            opacity: 0.7;
            display: block;
            margin-top: 3px;
        }

        .footer-links {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            font-size: 12px;
        }

        .footer-links a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .footer-links a:hover { color: var(--primary-light); }

        /* â”€â”€â”€ Responsive â”€â”€â”€ */
        @media (max-width: 768px) {
            #main-content { padding: 20px 16px 130px; }
            .nav-tabs { flex-direction: column; }
            .nav-tab { min-width: 100%; }
            .app-header { flex-direction: column; text-align: center; }
            .breathing-patterns { grid-template-columns: 1fr; }
            .tab-content { padding: 24px 20px; }
            .stats-overview { grid-template-columns: repeat(2, 1fr); }
            .emergency-actions { grid-template-columns: 1fr; }
        }

        /* â”€â”€â”€ Reduced Motion â”€â”€â”€ */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        .reduced-motion *, .reduced-motion *::before, .reduced-motion *::after {
            animation-duration: 0.01ms !important;
            transition-duration: 0.01ms !important;
            transform: none !important;
        }

        /* â”€â”€â”€ Scrollbar â”€â”€â”€ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    </style>
</head>
<body>
    <div id="main-content">
        <!-- Header -->
        <div class="app-header">
            <h1 class="title">
                <span class="pumpki-icon">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="14" r="8"/><path d="M12 6V2" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round"/><path d="M15 4c-1 1-2 2-3 2s-2-1-3-2" stroke="currentColor" fill="none" stroke-width="1.5" stroke-linecap="round"/></svg>
                </span>
                Pumpki
            </h1>
            <div class="accessibility-controls">
                <button class="control-btn" id="high-contrast-btn">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 3v18"/></svg>
                    Contrast
                </button>
                <button class="control-btn" id="reduced-motion-btn">
                    <svg viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    Motion
                </button>
                <button class="control-btn active" id="audio-toggle-btn">
                    <svg viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    Audio
                </button>
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer-bar">
            <div class="icon-wrap">
                <svg viewBox="0 0 24 24"><path d="M12 9v4M12 17h.01"/><circle cx="12" cy="12" r="10"/></svg>
            </div>
            <p>
                Pumpki is a gentle self-regulation tool designed for neurodivergent users. 
                It is <strong>not medical advice</strong> and is not a replacement for therapy, diagnosis, or crisis care.
                If you're experiencing persistent distress, please seek support from a licensed professional.
            </p>
        </div>

        <!-- Arousal State Check -->
        <div class="arousal-check">
            <h3>How are you feeling right now?</h3>
            <div class="arousal-scale" id="arousal-scale">
                <div class="arousal-option" data-state="very-low">
                    <div class="arousal-emoji">ðŸ˜´</div>
                    <div class="arousal-label">Very Calm</div>
                </div>
                <div class="arousal-option" data-state="low">
                    <div class="arousal-emoji">ðŸ˜Œ</div>
                    <div class="arousal-label">Calm</div>
                </div>
                <div class="arousal-option" data-state="medium">
                    <div class="arousal-emoji">ðŸ˜Š</div>
                    <div class="arousal-label">Just Right</div>
                </div>
                <div class="arousal-option" data-state="high">
                    <div class="arousal-emoji">ðŸ˜®</div>
                    <div class="arousal-label">Energized</div>
                </div>
                <div class="arousal-option" data-state="very-high">
                    <div class="arousal-emoji">ðŸ˜°</div>
                    <div class="arousal-label">Overwhelmed</div>
                </div>
            </div>
            
            <div class="brain-fact-inline">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                Your prefrontal cortex helps you notice and name your feelings â€” you're exercising it right now.
            </div>
        </div>

        <!-- Navigation tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="breathing">
                <svg viewBox="0 0 24 24"><path d="M12 22c-4-3-8-6-8-10a4 4 0 0 1 8 0 4 4 0 0 1 8 0c0 4-4 7-8 10z"/></svg>
                Breathing
            </button>
            <button class="nav-tab" data-tab="body-scan">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="3"/><path d="M12 8v8M8 20l4-4 4 4"/></svg>
                Body Check
            </button>
            <button class="nav-tab" data-tab="history">
                <svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 16l4-4 4 4 5-6"/></svg>
                My Progress
            </button>
            <button class="nav-tab" data-tab="emergency">
                <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4M12 17h.01"/></svg>
                Need Help Now
            </button>
        </div>

        <!-- Breathing tab -->
        <div class="tab-content" id="breathing-tab">
            <div class="canvas-container">
                <canvas id="pumpki-canvas" width="400" height="400"></canvas>
            </div>
            
            <div class="breathing-controls">
                <div class="breathing-timer" id="breathing-timer">
                    <div class="breathing-phase" id="breathing-phase">Choose a breathing pattern below</div>
                    <div id="timer-display">Ready</div>
                </div>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                    <button class="primary-btn" id="start-breathing-btn">Start Breathing</button>
                    <button class="secondary-btn" id="stop-breathing-btn">Stop</button>
                </div>

                <div class="breathing-patterns">
                    <div class="breathing-pattern active" data-pattern="box">
                        <div class="pattern-icon"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/></svg></div>
                        <h4>Box Breathing</h4>
                        <p>4 â€“ 4 â€“ 4 â€“ 4</p>
                        <small>In 4, Hold 4, Out 4, Hold 4<br>Best for: Balance &amp; Focus</small>
                    </div>
                    <div class="breathing-pattern" data-pattern="calm">
                        <div class="pattern-icon"><svg viewBox="0 0 24 24"><path d="M2 12c2-4 6-4 8 0s6 4 8 0M2 18c2-4 6-4 8 0s6 4 8 0"/></svg></div>
                        <h4>Calming Breath</h4>
                        <p>4 â€“ 6</p>
                        <small>In 4, Out 6<br>Best for: Anxiety &amp; Overwhelm</small>
                    </div>
                    <div class="breathing-pattern" data-pattern="energy">
                        <div class="pattern-icon"><svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
                        <h4>Energizing Breath</h4>
                        <p>6 â€“ 4</p>
                        <small>In 6, Out 4<br>Best for: Low Energy</small>
                    </div>
                </div>

                <div class="brain-tip">
                    <div class="brain-tip-header">
                        <div class="brain-tip-icon"><svg viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z"/><path d="M9 21h6M10 17v-1M14 17v-1"/></svg></div>
                        <h4 class="brain-tip-title">Cool Brain Fact</h4>
                    </div>
                    <div class="brain-tip-content">
                        When you breathe slowly, you're sending a "chill out" message to your amygdala (your brain's alarm system). Your vagus nerve is like a superhighway that carries calm signals from your breathing muscles to your brain.
                    </div>
                </div>

                <div class="fun-fact">
                    <svg viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    Audio tip: Sound waves help your brain sync with your breathing â€” the gentle tones guide your nervous system into calm.
                </div>
            </div>
        </div>

        <!-- Body scan tab -->
        <div class="tab-content hidden" id="body-scan-tab">
            <div class="body-scan-container">
                <h3>Body Check-In</h3>
                <p id="body-scan-instruction" style="color: var(--text-secondary); font-size: 14px;">Tap different parts of your body to show how they feel, or try a guided body scan:</p>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin: 16px 0; flex-wrap: wrap;">
                    <button class="secondary-btn" id="guided-scan-btn">Guided Body Scan</button>
                    <button class="secondary-btn" id="quick-check-btn">Quick Check</button>
                    <button class="secondary-btn" id="body-scan-reset">Reset</button>
                </div>
                
                <div class="body-outline-container">
                    <svg class="body-outline" viewBox="0 0 200 350" xmlns="http://www.w3.org/2000/svg">
                        <ellipse class="body-part neutral" data-part="head" cx="100" cy="40" rx="25" ry="30" />
                        <rect class="body-part neutral" data-part="neck" x="90" y="65" width="20" height="15" rx="5" />
                        <ellipse class="body-part neutral" data-part="chest" cx="100" cy="120" rx="35" ry="25" />
                        <ellipse class="body-part neutral" data-part="stomach" cx="100" cy="160" rx="30" ry="20" />
                        <rect class="body-part neutral" data-part="left-arm" x="55" y="90" width="12" height="50" rx="6" />
                        <rect class="body-part neutral" data-part="right-arm" x="133" y="90" width="12" height="50" rx="6" />
                        <rect class="body-part neutral" data-part="left-leg" x="80" y="185" width="15" height="70" rx="7" />
                        <rect class="body-part neutral" data-part="right-leg" x="105" y="185" width="15" height="70" rx="7" />
                        <ellipse class="body-part neutral" data-part="left-foot" cx="87" cy="275" rx="12" ry="8" />
                        <ellipse class="body-part neutral" data-part="right-foot" cx="113" cy="275" rx="12" ry="8" />
                    </svg>
                </div>

                <div class="body-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--success);"></div>
                        <span>Comfortable</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--slate);"></div>
                        <span>Neutral</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--error);"></div>
                        <span>Tense</span>
                    </div>
                </div>

                <div class="guided-scan-area hidden" id="guided-scan-area">
                    <div class="scan-progress-bar">
                        <div class="scan-progress-fill" id="scan-progress-fill"></div>
                    </div>
                    <div class="scan-instruction" id="current-scan-instruction">
                        Focus on your head. Notice any tension, warmth, or other feelings.
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="primary-btn" id="scan-next-btn">Next Area</button>
                        <button class="secondary-btn" id="scan-stop-btn">Stop Scan</button>
                    </div>
                </div>

                <div class="sensations-tracker" id="sensations-tracker">
                    <h4>What are you noticing in your body?</h4>
                    <div class="sensation-options">
                        <div class="sensation-tag" data-sensation="warm">Warm</div>
                        <div class="sensation-tag" data-sensation="cool">Cool</div>
                        <div class="sensation-tag" data-sensation="tight">Tight</div>
                        <div class="sensation-tag" data-sensation="relaxed">Relaxed</div>
                        <div class="sensation-tag" data-sensation="tingly">Tingly</div>
                        <div class="sensation-tag" data-sensation="heavy">Heavy</div>
                        <div class="sensation-tag" data-sensation="light">Light</div>
                        <div class="sensation-tag" data-sensation="buzzy">Buzzy</div>
                        <div class="sensation-tag" data-sensation="achy">Achy</div>
                        <div class="sensation-tag" data-sensation="energized">Energized</div>
                    </div>
                </div>

                <div class="brain-tip mini">
                    <div class="brain-tip-header">
                        <div class="brain-tip-icon"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
                        <h4 class="brain-tip-title">Body-Brain Connection</h4>
                    </div>
                    <div class="brain-tip-content">
                        Your brain has special sensors called "interoceptors" â€” tiny detectives constantly reporting what's happening inside your body. When you practice noticing these feelings, you're training your interoceptive network to be smarter about your needs.
                    </div>
                </div>

                <div class="tab-content hidden" id="scan-results">
                    <h4>Your Body Check Summary</h4>
                    <div class="results-content" id="results-content"></div>
                    <div style="text-align: center; margin-top: 16px;">
                        <button class="primary-btn" id="save-body-check">Save This Check-in</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History tab -->
        <div class="tab-content hidden" id="history-tab">
            <h3 style="text-align: center; margin-bottom: 28px; font-family: var(--serif); font-size: 24px; font-weight: 400;">My Regulation Journey</h3>
            
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-number" id="total-sessions">0</div>
                    <div class="stat-label">Breathing Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-body-checks">0</div>
                    <div class="stat-label">Body Check-ins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="current-streak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-minutes-practiced">0</div>
                    <div class="stat-label">Minutes Practiced</div>
                </div>
            </div>

            <div class="mood-chart-container">
                <h4>This Week's Feelings</h4>
                <div class="mood-chart" id="weekly-mood-chart"></div>
            </div>

            <div class="brain-tip">
                <div class="brain-tip-header">
                    <div class="brain-tip-icon"><svg viewBox="0 0 24 24"><path d="M12 22c-4-3-8-6-8-10a4 4 0 0 1 8 0 4 4 0 0 1 8 0c0 4-4 7-8 10z"/></svg></div>
                    <h4 class="brain-tip-title">Your Brain is Always Growing</h4>
                </div>
                <div class="brain-tip-content">
                    Every time you practice breathing or body scans, you're literally rewiring your brain. Scientists call this "neuroplasticity" â€” your brain creates new pathways like building new roads. The more you practice, the stronger these calm-down highways become.
                </div>
            </div>

            <div class="fun-fact">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                Your brain makes about 700 new connections every second when you're learning something new.
            </div>

            <div class="recent-entries">
                <div class="entries-header">
                    <h4>Recent Entries</h4>
                    <div class="entry-filters">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="breathing">Breathing</button>
                        <button class="filter-btn" data-filter="body-check">Body Checks</button>
                        <button class="filter-btn" data-filter="mood">Mood</button>
                    </div>
                </div>
                <div class="entries-list" id="entries-list"></div>
            </div>

            <div class="data-management">
                <h4>Manage Your Data</h4>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="secondary-btn" id="export-data-btn">Export Data</button>
                    <button class="secondary-btn" id="import-data-btn">Import Data</button>
                    <button class="secondary-btn" id="clear-old-data-btn">Clear Old Data</button>
                </div>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <p>Export your data to save a backup, or import to restore from a previous backup.</p>
            </div>
        </div>

        <!-- Emergency tab -->
        <div class="tab-content hidden" id="emergency-tab">
            <div class="emergency-notice">
                <div class="icon-wrap">
                    <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4M12 17h.01"/></svg>
                </div>
                <div>
                    <h3>Crisis Support Notice</h3>
                    <p>
                        This tool is <strong>not a crisis intervention service</strong>. 
                        If you are in immediate danger or feel unable to keep yourself safe, 
                        please contact your local emergency number or a trusted crisis resource.
                    </p>
                </div>
            </div>
                
            <div class="emergency-actions">
                <button class="emergency-btn" id="emergency-breathing">
                    <svg viewBox="0 0 24 24"><path d="M12 22c-4-3-8-6-8-10a4 4 0 0 1 8 0 4 4 0 0 1 8 0c0 4-4 7-8 10z"/></svg>
                    Crisis Breathing
                </button>
                <button class="emergency-btn" id="grounding-54321">
                    <svg viewBox="0 0 24 24"><path d="M6 18h.01M10 18h.01M14 18h.01M18 18h.01M8 14h.01M12 14h.01M16 14h.01M10 10h.01M14 10h.01M12 6h.01"/></svg>
                    5-4-3-2-1 Grounding
                </button>
                <button class="emergency-btn" id="cold-water">
                    <svg viewBox="0 0 24 24"><path d="M12 2v6M12 22c-3 0-6-2-6-6 0-3.5 6-10 6-10s6 6.5 6 10c0 4-3 6-6 6z"/></svg>
                    Cold Water Reset
                </button>
                <button class="emergency-btn" id="safe-place">
                    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z"/><path d="M9 22V12h6v10"/></svg>
                    Find Safe Space
                </button>
            </div>

            <div class="remember-list">
                <h4>Remember</h4>
                <ul>
                    <li><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg> This feeling will pass</li>
                    <li><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> You are safe right now</li>
                    <li><svg viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg> You have tools to help yourself</li>
                    <li><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg> It's okay to ask for help</li>
                </ul>
            </div>

            <div class="brain-tip" style="margin-top: 20px;">
                <div class="brain-tip-header">
                    <div class="brain-tip-icon"><svg viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z"/><path d="M9 21h6"/></svg></div>
                    <h4 class="brain-tip-title">What's Happening in Your Brain</h4>
                </div>
                <div class="brain-tip-content">
                    When you feel overwhelmed, your amygdala (alarm system) is trying to protect you by releasing stress hormones. It's like a smoke detector that's being extra careful. The breathing techniques help tell your brain "false alarm â€” we're safe" and activate your parasympathetic nervous system (your body's natural calm-down system).
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-company">
            Â© 2026 Her Own Terms, LLC
            <span class="footer-tagline">Montreal, Quebec, Canada Â· Built with care for neurodivergent minds</span>
        </div>
        <div class="footer-links">
            <a href="#" onclick="showLegalModal('about'); return false;">About</a>
            <a href="#" onclick="showLegalModal('privacy'); return false;">Data &amp; Privacy</a>
            <a href="#" onclick="showLegalModal('medical'); return false;">Medical Disclaimer</a>
            <a href="#" onclick="showLegalModal('terms'); return false;">Terms of Use</a>
            <a href="#" onclick="showLegalModal('accessibility'); return false;">Accessibility</a>
        </div>
    </footer>

    <script>
        // Legal modal system
        function showLegalModal(type) {
            const existingModal = document.querySelector('.legal-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.className = 'legal-modal active';
            modal.innerHTML = `
                <div class="legal-modal-content">
                    <button class="legal-modal-close" onclick="this.closest('.legal-modal').remove()">Ã—</button>
                    ${getLegalContent(type)}
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        function getLegalContent(type) {
            const content = {
                about: `
                    <h2>About Pumpki</h2>
                    <p>Pumpki is a gentle self-regulation and nervous-system support tool designed specifically for neurodivergent users.</p>
                    <h3>Research Foundation</h3>
                    <p>Pumpki incorporates techniques informed by neuroscience research on breathing, interoception, and nervous system regulation. These are educational tools for self-exploration, not medical treatments or therapeutic interventions.</p>
                    <p>Created by Her Own Terms, LLC in Montreal, Quebec, Pumpki combines breathing exercises, body awareness techniques, and neuroscience education to support self-regulation and emotional wellness.</p>
                    <p><strong>What Pumpki is:</strong></p>
                    <ul><li>A self-regulation practice tool</li><li>An educational resource about nervous system states</li><li>A personal tracking system for your wellness journey</li></ul>
                    <p><strong>What Pumpki is NOT:</strong></p>
                    <ul><li>Medical or psychological treatment</li><li>A replacement for professional care</li><li>A crisis intervention service</li></ul>
                `,
                privacy: `
                    <h2>Data & Privacy</h2>
                    <h3>Your Data Stays With You</h3>
                    <p>Pumpki stores your entries <strong>locally on your device only</strong> using your browser's IndexedDB storage.</p>
                    <p><strong>What this means:</strong></p>
                    <ul><li>No accounts required</li><li>No cloud storage</li><li>No data is sent to our servers</li><li>No analytics or tracking</li><li>No third-party data sharing</li></ul>
                    <h3>Your Control</h3>
                    <p>You can export or delete your data at any time using the controls in the "My Progress" tab.</p>
                    <h3>Browser Storage</h3>
                    <p>Your data is stored in your browser's local IndexedDB database. Clearing your browser data will delete your Pumpki entries.</p>
                    <p>We recommend exporting your data regularly as a backup if you want to preserve your progress records.</p>
                    <h3>No Collection Policy</h3>
                    <p>Her Own Terms, LLC does not collect, store, or have access to any data you create in Pumpki. Your information never leaves your device.</p>
                `,
                medical: `
                    <h2>Medical Disclaimer</h2>
                    <p><strong>Important: Please read carefully</strong></p>
                    <p>The tools on this website are provided for <strong>educational, self-reflection, and self-regulation purposes only</strong>.</p>
                    <p>They are <strong>not intended to diagnose, treat, cure, or prevent any medical or mental health condition</strong>, and should not be used as a substitute for professional care.</p>
                    <h3>When to Seek Professional Help</h3>
                    <p>If you are experiencing any of the following, please seek support from a licensed professional or local emergency services:</p>
                    <ul><li>Persistent distress or emotional pain</li><li>Thoughts of self-harm or suicide</li><li>Inability to care for yourself</li><li>Symptoms that interfere with daily life</li><li>A mental health crisis</li></ul>
                    <p style="color: var(--primary); font-weight: 600; margin-top: 24px;">You deserve support, and needing help does not mean you've failed.</p>
                    <h3>Canadian Crisis Resources</h3>
                    <p><strong>If you're in immediate danger:</strong></p>
                    <ul><li><strong>Emergency:</strong> Call 911</li><li><strong>988 Suicide Crisis Helpline (Canada):</strong> Call or text 988</li><li><strong>Kids Help Phone (ages 5-29):</strong> Text CONNECT to 686868 or call 1-800-668-6868</li><li><strong>Talk Suicide Canada:</strong> 1-833-456-4566 (available 24/7)</li><li><strong>Crisis Text Line (Canada):</strong> Text HOME to 741741</li></ul>
                    <p style="margin-top: 20px;"><strong>Quebec-specific resources:</strong></p>
                    <ul><li><strong>Tel-Aide:</strong> 514-935-1101 (Montreal)</li><li><strong>Suicide Action Montreal:</strong> 1-866-277-3553</li><li><strong>Info-Social 811:</strong> Dial 811 for health and social services info</li></ul>
                `,
                terms: `
                    <h2>Terms of Use</h2>
                    <p>By using Pumpki, you agree to the following terms:</p>
                    <h3>Use of the Tool</h3>
                    <ul><li>You are using the tools voluntarily and at your own discretion</li><li>You understand they are not medical or therapeutic services</li><li>You will not hold Her Own Terms, LLC liable for how you choose to use the tools</li></ul>
                    <h3>No Warranty</h3>
                    <p>These tools are offered "as is" without warranty of any kind. We make no guarantees about results, outcomes, or suitability for your specific needs.</p>
                    <h3>Your Responsibility</h3>
                    <ul><li>Using the tools safely and appropriately</li><li>Seeking professional help when needed</li><li>Backing up your data if desired</li><li>Understanding the limitations of self-regulation tools</li></ul>
                    <h3>Intellectual Property</h3>
                    <p>All original text, design, code, and tools on this site are Â© 2026 Her Own Terms, LLC unless otherwise stated.</p>
                    <h3>Good Faith</h3>
                    <p>These tools are offered in good faith, with care and intention to support neurodivergent individuals in their self-regulation journey.</p>
                `,
                accessibility: `
                    <h2>Accessibility & Design</h2>
                    <h3>Design Intent</h3>
                    <p>Pumpki is intentionally designed to support neurodivergent users, including those with sensory sensitivities, anxiety disorders, ADHD, autism spectrum conditions, trauma histories, and other neurodevelopmental differences.</p>
                    <h3>Accessibility Features</h3>
                    <ul><li><strong>Reduced motion option</strong> â€” Minimizes animations and transitions</li><li><strong>High contrast mode</strong> â€” Increases visual clarity</li><li><strong>Gentle audio cues</strong> â€” Optional breathing guidance with soft tones</li><li><strong>Non-judgmental language</strong> â€” Supportive, shame-free communication</li><li><strong>Calming color palette</strong> â€” Warm, earthy tones designed to be soothing</li><li><strong>Local data storage</strong> â€” No accounts or complex setup required</li><li><strong>Flexible pacing</strong> â€” Use tools at your own speed</li></ul>
                    <h3>Important Note</h3>
                    <p>These features are <strong>intentional design choices</strong>, not clinical guarantees or medical treatments.</p>
                    <h3>Browser Compatibility</h3>
                    <p>Pumpki works best on modern browsers (Chrome, Firefox, Safari, Edge).</p>
                `
            };
            return content[type] || '<p>Content not found</p>';
        }

        // â”€â”€â”€ IndexedDB Database Manager â”€â”€â”€
        class PumpkiDB {
            constructor() { this.dbName = 'PumpkiDB'; this.version = 1; this.db = null; }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => { this.db = request.result; resolve(this.db); };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('breathingSessions')) {
                            const s = db.createObjectStore('breathingSessions', { keyPath: 'id', autoIncrement: true });
                            s.createIndex('timestamp', 'timestamp', { unique: false });
                            s.createIndex('date', 'date', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('bodyCheckIns')) {
                            const s = db.createObjectStore('bodyCheckIns', { keyPath: 'id', autoIncrement: true });
                            s.createIndex('timestamp', 'timestamp', { unique: false });
                            s.createIndex('date', 'date', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('moodEntries')) {
                            const s = db.createObjectStore('moodEntries', { keyPath: 'id', autoIncrement: true });
                            s.createIndex('timestamp', 'timestamp', { unique: false });
                            s.createIndex('date', 'date', { unique: false });
                        }
                    };
                });
            }

            async saveBreathingSession(data) {
                const store = this.db.transaction(['breathingSessions'], 'readwrite').objectStore('breathingSessions');
                return store.add({ timestamp: new Date().toISOString(), date: new Date().toDateString(), ...data });
            }

            async saveBodyCheckIn(data) {
                const store = this.db.transaction(['bodyCheckIns'], 'readwrite').objectStore('bodyCheckIns');
                return store.add({ timestamp: new Date().toISOString(), date: new Date().toDateString(), ...data });
            }

            async saveMoodEntry(data) {
                const store = this.db.transaction(['moodEntries'], 'readwrite').objectStore('moodEntries');
                return store.add({ timestamp: new Date().toISOString(), date: new Date().toDateString(), ...data });
            }

            async getAllEntries(storeName) {
                const index = this.db.transaction([storeName], 'readonly').objectStore(storeName).index('timestamp');
                return new Promise((resolve, reject) => {
                    const r = index.getAll();
                    r.onsuccess = () => resolve(r.result.reverse());
                    r.onerror = () => reject(r.error);
                });
            }

            async getEntriesByDateRange(storeName, startDate, endDate) {
                const index = this.db.transaction([storeName], 'readonly').objectStore(storeName).index('timestamp');
                const range = IDBKeyRange.bound(startDate.toISOString(), endDate.toISOString());
                return new Promise((resolve, reject) => {
                    const r = index.getAll(range);
                    r.onsuccess = () => resolve(r.result);
                    r.onerror = () => reject(r.error);
                });
            }

            async getRecentEntries(days = 7) {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);
                const [breathing, bodyChecks, moods] = await Promise.all([
                    this.getEntriesByDateRange('breathingSessions', startDate, endDate),
                    this.getEntriesByDateRange('bodyCheckIns', startDate, endDate),
                    this.getEntriesByDateRange('moodEntries', startDate, endDate)
                ]);
                return { breathing, bodyChecks, moods };
            }

            async getStats() {
                const breathing = await this.getAllEntries('breathingSessions');
                const bodyChecks = await this.getAllEntries('bodyCheckIns');
                const moods = await this.getAllEntries('moodEntries');
                const totalMinutes = breathing.reduce((sum, s) => sum + (s.duration || 0), 0);
                return {
                    totalSessions: breathing.length,
                    totalBodyChecks: bodyChecks.length,
                    totalMoods: moods.length,
                    totalMinutes,
                    currentStreak: this.calculateStreak(breathing.concat(bodyChecks).concat(moods))
                };
            }

            calculateStreak(entries) {
                if (!entries.length) return 0;
                const dates = [...new Set(entries.map(e => e.date))].sort().reverse();
                let streak = 0, currentDate = new Date();
                for (let i = 0; i < dates.length; i++) {
                    if (dates.includes(currentDate.toDateString())) {
                        streak++;
                        currentDate.setDate(currentDate.getDate() - 1);
                    } else break;
                }
                return streak;
            }

            async exportAllData() {
                const [breathing, bodyChecks, moods] = await Promise.all([
                    this.getAllEntries('breathingSessions'),
                    this.getAllEntries('bodyCheckIns'),
                    this.getAllEntries('moodEntries')
                ]);
                return { exportDate: new Date().toISOString(), breathingSessions: breathing, bodyCheckIns: bodyChecks, moodEntries: moods };
            }

            async clearOldData(daysToKeep = 30) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
                const stores = ['breathingSessions', 'bodyCheckIns', 'moodEntries'];
                const transaction = this.db.transaction(stores, 'readwrite');
                for (const storeName of stores) {
                    const index = transaction.objectStore(storeName).index('timestamp');
                    const range = IDBKeyRange.upperBound(cutoffDate.toISOString());
                    const request = index.openCursor(range);
                    request.onsuccess = (e) => { const cursor = e.target.result; if (cursor) { cursor.delete(); cursor.continue(); } };
                }
                return transaction.complete;
            }

            async deleteEntry(storeName, id) {
                return this.db.transaction([storeName], 'readwrite').objectStore(storeName).delete(id);
            }
        }

        // â”€â”€â”€ Main App â”€â”€â”€
        class PumpkiApp {
            constructor() {
                this.canvas = document.getElementById('pumpki-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.currentTab = 'breathing';
                this.currentArousal = null;
                this.isBreathing = false;
                this.breathingPattern = 'box';
                this.breathingTimer = null;
                this.phaseTime = 0;
                this.currentPhaseIndex = 0;
                this.bodyScanData = {};
                this.selectedSensations = [];
                this.guidedScanAreas = [];
                this.currentScanIndex = 0;
                this.db = new PumpkiDB();
                this.sessionStartTime = null;
                this.sessionStartArousal = null;
                this.currentFilter = 'all';
                this.audioEnabled = true;
                this.audioContext = null;
                this.masterGain = null;

                this.patterns = {
                    box: { phases: ['inhale','hold','exhale','hold'], durations: [4,4,4,4], instructions: ['Breathe In','Hold','Breathe Out','Hold'] },
                    calm: { phases: ['inhale','exhale'], durations: [4,6], instructions: ['Breathe In','Breathe Out Slowly'] },
                    energy: { phases: ['inhale','exhale'], durations: [6,4], instructions: ['Deep Breath In','Quick Out'] }
                };

                this.breathingScale = 1;
                this.maxScale = 1.4;
                this.currentTime = 0;

                this.setupCanvas();
                this.startAnimation();
                this.initializeApp();
            }

            async initializeApp() {
                try {
                    await this.db.init();
                    this.initializeEventListeners();
                    await this.loadHistoryData();
                } catch (error) {
                    console.error('DB init failed:', error);
                    this.initializeEventListeners();
                }
            }

            setupCanvas() {
                const dpr = window.devicePixelRatio || 1;
                this.canvas.width = 400 * dpr;
                this.canvas.height = 400 * dpr;
                this.canvas.style.width = '400px';
                this.canvas.style.height = '400px';
                this.ctx.scale(dpr, dpr);
                this.centerX = 200;
                this.centerY = 200;
            }

            initializeEventListeners() {
                document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', (e) => this.switchTab(e.target.closest('.nav-tab').dataset.tab)));
                document.getElementById('high-contrast-btn').addEventListener('click', () => { document.body.classList.toggle('high-contrast'); document.getElementById('high-contrast-btn').classList.toggle('active'); });
                document.getElementById('reduced-motion-btn').addEventListener('click', () => { document.body.classList.toggle('reduced-motion'); document.getElementById('reduced-motion-btn').classList.toggle('active'); });
                document.getElementById('audio-toggle-btn').addEventListener('click', this.toggleAudio.bind(this));
                document.querySelectorAll('.arousal-option').forEach(o => o.addEventListener('click', (e) => this.setArousalState(e.currentTarget.dataset.state)));
                document.getElementById('start-breathing-btn').addEventListener('click', this.startBreathing.bind(this));
                document.getElementById('stop-breathing-btn').addEventListener('click', this.stopBreathing.bind(this));
                document.querySelectorAll('.breathing-pattern').forEach(p => p.addEventListener('click', (e) => this.selectBreathingPattern(e.currentTarget.dataset.pattern)));
                document.querySelectorAll('.body-part').forEach(p => p.addEventListener('click', (e) => this.toggleBodyPart(e.target)));
                document.getElementById('body-scan-reset').addEventListener('click', this.resetBodyScan.bind(this));
                document.getElementById('guided-scan-btn').addEventListener('click', this.startGuidedScan.bind(this));
                document.getElementById('quick-check-btn').addEventListener('click', this.startQuickCheck.bind(this));
                document.getElementById('scan-next-btn').addEventListener('click', this.nextScanArea.bind(this));
                document.getElementById('scan-stop-btn').addEventListener('click', this.stopGuidedScan.bind(this));
                document.getElementById('save-body-check').addEventListener('click', this.saveBodyCheck.bind(this));
                document.querySelectorAll('.sensation-tag').forEach(t => t.addEventListener('click', (e) => this.toggleSensation(e.target)));
                document.querySelectorAll('.filter-btn').forEach(b => b.addEventListener('click', (e) => this.setHistoryFilter(e.target.dataset.filter)));
                document.getElementById('export-data-btn').addEventListener('click', this.exportData.bind(this));
                document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
                document.getElementById('clear-old-data-btn').addEventListener('click', this.clearOldData.bind(this));
                document.getElementById('import-file-input').addEventListener('change', this.handleFileImport.bind(this));
                document.getElementById('emergency-breathing').addEventListener('click', this.startEmergencyBreathing.bind(this));
                document.getElementById('grounding-54321').addEventListener('click', () => alert('5-4-3-2-1 Grounding Technique:\n\n5 things you can SEE\n4 things you can TOUCH\n3 things you can HEAR\n2 things you can SMELL\n1 thing you can TASTE\n\nTake your time with each one.'));
                document.getElementById('cold-water').addEventListener('click', () => alert('Cold Water Technique:\n\nPut cold water on your wrists\nSplash some on your face\nHold an ice cube\nDrink cold water slowly\n\nThis helps reset your nervous system.'));
                document.getElementById('safe-place').addEventListener('click', () => alert('Find Your Safe Space:\n\nGo to your room or quiet space\nGet your comfort items\nPut on calming music\nTake slow, deep breaths\n\nYou are safe. This will pass.'));
            }

            switchTab(tabName) {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                this.currentTab = tabName;
                if (tabName === 'history') this.loadHistoryData();
            }

            setArousalState(state) {
                this.currentArousal = state;
                document.querySelectorAll('.arousal-option').forEach(o => o.classList.remove('selected'));
                document.querySelector(`[data-state="${state}"]`).classList.add('selected');
                this.recommendBreathingPattern(state);
                this.saveMoodEntry(state);
            }

            async saveMoodEntry(arousalState) {
                if (!this.db.db) return;
                try { await this.db.saveMoodEntry({ arousalState }); } catch (e) { console.error(e); }
            }

            recommendBreathingPattern(state) {
                const map = { 'very-low': 'energy', 'low': 'energy', 'high': 'calm', 'very-high': 'calm' };
                this.selectBreathingPattern(map[state] || 'box');
            }

            selectBreathingPattern(pattern) {
                if (!this.patterns[pattern]) return;
                document.querySelectorAll('.breathing-pattern').forEach(p => p.classList.remove('active'));
                const el = document.querySelector(`[data-pattern="${pattern}"]`);
                if (el) el.classList.add('active');
                this.breathingPattern = pattern;
            }

            startBreathing() {
                if (this.isBreathing) return;
                this.isBreathing = true;
                this.currentPhaseIndex = 0;
                this.phaseTime = 0;
                this.sessionStartTime = new Date();
                this.sessionStartArousal = this.currentArousal;
                this.completedCycles = 0;
                const btn = document.getElementById('start-breathing-btn');
                btn.textContent = 'Breathing...';
                btn.disabled = true;
                if (this.audioEnabled) this.playSuccessSound();
                this.runBreathingCycle();
            }

            stopBreathing() {
                this.isBreathing = false;
                if (this.breathingTimer) { clearInterval(this.breathingTimer); this.breathingTimer = null; }
                this.currentPhaseIndex = 0;
                this.phaseTime = 0;
                this.breathingScale = 1;
                const btn = document.getElementById('start-breathing-btn');
                btn.textContent = 'Start Breathing';
                btn.disabled = false;
                document.getElementById('breathing-phase').textContent = 'Choose a breathing pattern below';
                document.getElementById('timer-display').textContent = 'Ready';
                if (this.sessionStartTime) {
                    const duration = Math.floor((new Date() - this.sessionStartTime) / 1000 / 60);
                    if (duration >= 1) this.saveBreathingSession(duration);
                    this.sessionStartTime = null;
                }
            }

            async saveBreathingSession(duration) {
                if (!this.db.db) return;
                try { await this.db.saveBreathingSession({ pattern: this.breathingPattern, duration, completedCycles: this.completedCycles || 0, arousalBefore: this.sessionStartArousal, arousalAfter: this.currentArousal }); } catch (e) { console.error(e); }
            }

            runBreathingCycle() {
                if (!this.isBreathing) return;
                const pattern = this.patterns[this.breathingPattern];
                if (!pattern) return;
                const currentPhase = pattern.phases[this.currentPhaseIndex];
                const phaseDuration = pattern.durations[this.currentPhaseIndex];
                const instruction = pattern.instructions[this.currentPhaseIndex];
                if (!phaseDuration) return;
                document.getElementById('breathing-phase').textContent = instruction;
                if (this.audioEnabled) this.playBreathingCue(currentPhase, phaseDuration);
                this.phaseTime = Math.floor(phaseDuration);
                this.breathingTimer = setInterval(() => {
                    if (!this.isBreathing) return;
                    this.phaseTime = Math.max(0, this.phaseTime - 1);
                    document.getElementById('timer-display').textContent = this.phaseTime;
                    this.updateBreathingVisual(currentPhase, this.phaseTime, phaseDuration);
                    if (this.phaseTime <= 0) {
                        clearInterval(this.breathingTimer);
                        this.currentPhaseIndex = (this.currentPhaseIndex + 1) % pattern.phases.length;
                        if (this.currentPhaseIndex === 0) this.completedCycles = (this.completedCycles || 0) + 1;
                        setTimeout(() => this.runBreathingCycle(), 100);
                    }
                }, 1000);
            }

            updateBreathingVisual(phase, timeLeft, duration) {
                if (!duration) return;
                const progress = Math.min(1, Math.max(0, (duration - Math.max(0, timeLeft)) / duration));
                switch(phase) {
                    case 'inhale': this.breathingScale = Math.max(1, Math.min(this.maxScale, 1 + (progress * 0.4))); break;
                    case 'exhale': this.breathingScale = Math.max(1, Math.min(this.maxScale, this.maxScale - (progress * 0.4))); break;
                    case 'hold': this.breathingScale = this.currentPhaseIndex === 1 ? this.maxScale : 1; break;
                    default: this.breathingScale = 1;
                }
                if (isNaN(this.breathingScale) || this.breathingScale < 1) this.breathingScale = 1;
            }

            startEmergencyBreathing() {
                this.setArousalState('very-high');
                this.selectBreathingPattern('calm');
                this.switchTab('breathing');
                if (this.audioEnabled) this.ensureAudioContext().then(() => this.playBreathingCue('exhale', 2));
                setTimeout(() => this.startBreathing(), 500);
            }

            // Body scan
            toggleBodyPart(element) {
                const states = ['neutral', 'comfortable', 'tense'];
                let idx = states.findIndex(s => element.classList.contains(s));
                if (idx >= 0) element.classList.remove(states[idx]);
                element.classList.add(states[(idx + 1) % states.length]);
                this.updateScanResults();
            }

            resetBodyScan() {
                document.querySelectorAll('.body-part').forEach(p => { p.classList.remove('comfortable', 'tense', 'active'); p.classList.add('neutral'); });
                document.querySelectorAll('.sensation-tag').forEach(t => t.classList.remove('selected'));
                document.getElementById('scan-results').classList.add('hidden');
                this.bodyScanData = {};
                this.selectedSensations = [];
            }

            startGuidedScan() {
                this.currentScanType = 'guided';
                document.getElementById('guided-scan-area').classList.remove('hidden');
                document.getElementById('sensations-tracker').classList.add('hidden');
                this.guidedScanAreas = [
                    { part: 'head', instruction: 'Focus on your head and face. Notice any tension in your forehead, jaw, or temples. Take a deep breath.' },
                    { part: 'neck', instruction: 'Move your attention to your neck and shoulders. Are they tight or relaxed? Gently roll your shoulders.' },
                    { part: 'chest', instruction: 'Notice your chest and breathing. Is your breath shallow or deep? Feel your heartbeat.' },
                    { part: 'left-arm', instruction: 'Focus on your left arm. Make a fist, then relax. Notice the difference.' },
                    { part: 'right-arm', instruction: 'Now your right arm. Stretch it up high, then let it drop. How does it feel?' },
                    { part: 'stomach', instruction: 'Check in with your belly. Is it tight, relaxed, or maybe hungry? Breathe into this area.' },
                    { part: 'left-leg', instruction: 'Focus on your left leg. Tense the muscles, then relax them completely.' },
                    { part: 'right-leg', instruction: 'Now your right leg. Point your toes, then flex them. Notice the sensations.' },
                    { part: 'left-foot', instruction: 'Focus on your left foot. Wiggle your toes. How does the ground feel underneath?' },
                    { part: 'right-foot', instruction: 'Finally, your right foot. Take a moment to feel both feet on the ground.' }
                ];
                this.currentScanIndex = 0;
                this.nextScanArea();
            }

            nextScanArea() {
                if (this.currentScanIndex >= this.guidedScanAreas.length) { this.completeScan(); return; }
                const area = this.guidedScanAreas[this.currentScanIndex];
                document.querySelectorAll('.body-part').forEach(p => p.classList.remove('active'));
                const bp = document.querySelector(`[data-part="${area.part}"]`);
                if (bp) bp.classList.add('active');
                document.getElementById('current-scan-instruction').textContent = area.instruction;
                if (this.audioEnabled) this.playTransitionChime();
                document.getElementById('scan-progress-fill').style.width = ((this.currentScanIndex + 1) / this.guidedScanAreas.length * 100) + '%';
                this.currentScanIndex++;
            }

            stopGuidedScan() {
                document.getElementById('guided-scan-area').classList.add('hidden');
                document.getElementById('sensations-tracker').classList.remove('hidden');
                document.querySelectorAll('.body-part').forEach(p => p.classList.remove('active'));
            }

            completeScan() {
                document.getElementById('guided-scan-area').classList.add('hidden');
                document.getElementById('sensations-tracker').classList.remove('hidden');
                document.querySelectorAll('.body-part').forEach(p => p.classList.remove('active'));
                if (this.audioEnabled) this.playSuccessSound();
                alert('Great job completing the body scan!\n\nNow you can tap any body parts and select sensations to finish your check-in.');
                this.updateScanResults();
            }

            startQuickCheck() {
                this.currentScanType = 'quick';
                document.getElementById('sensations-tracker').classList.remove('hidden');
                document.getElementById('guided-scan-area').classList.add('hidden');
            }

            toggleSensation(element) {
                element.classList.toggle('selected');
                const s = element.dataset.sensation;
                if (!this.selectedSensations) this.selectedSensations = [];
                if (element.classList.contains('selected')) { if (!this.selectedSensations.includes(s)) this.selectedSensations.push(s); }
                else { this.selectedSensations = this.selectedSensations.filter(x => x !== s); }
                this.updateScanResults();
            }

            updateScanResults() {
                const resultsDiv = document.getElementById('scan-results');
                const contentDiv = document.getElementById('results-content');
                const bodyStates = {};
                document.querySelectorAll('.body-part').forEach(p => {
                    const name = p.dataset.part.replace('-', ' ');
                    if (p.classList.contains('comfortable')) bodyStates[name] = 'comfortable';
                    else if (p.classList.contains('tense')) bodyStates[name] = 'tense';
                });
                const hasBody = Object.keys(bodyStates).length > 0;
                const hasSens = this.selectedSensations && this.selectedSensations.length > 0;
                if (hasBody || hasSens) {
                    let html = '';
                    if (hasBody) {
                        html += '<div style="margin-bottom:12px"><strong>Body Areas:</strong></div>';
                        for (const [part, state] of Object.entries(bodyStates)) {
                            const color = state === 'comfortable' ? 'var(--success)' : 'var(--error)';
                            html += `<div style="padding:6px 0;border-bottom:1px solid var(--border)"><span style="font-weight:500;color:var(--primary)">${part}:</span> <span style="color:${color}">${state}</span></div>`;
                        }
                    }
                    if (hasSens) {
                        html += '<div style="margin:12px 0 8px"><strong>Sensations:</strong></div>';
                        html += '<div>' + this.selectedSensations.join(', ') + '</div>';
                    }
                    contentDiv.innerHTML = html;
                    resultsDiv.classList.remove('hidden');
                } else resultsDiv.classList.add('hidden');
            }

            saveBodyCheck() {
                const bodyStates = {};
                document.querySelectorAll('.body-part').forEach(p => {
                    const name = p.dataset.part.replace('-', ' ');
                    if (p.classList.contains('comfortable')) bodyStates[name] = 'comfortable';
                    else if (p.classList.contains('tense')) bodyStates[name] = 'tense';
                });
                const data = { bodyStates, sensations: this.selectedSensations || [], scanType: this.currentScanType || 'manual', arousalState: this.currentArousal };
                if (this.db.db) this.db.saveBodyCheckIn(data).catch(e => console.error(e));
                if (this.audioEnabled) this.playSuccessSound();
                alert('Body check saved!\n\nKeep tracking how your body feels to better understand your patterns.');
            }

            // History
            async loadHistoryData() {
                if (!this.db.db) return;
                try {
                    const stats = await this.db.getStats();
                    document.getElementById('total-sessions').textContent = stats.totalSessions;
                    document.getElementById('total-body-checks').textContent = stats.totalBodyChecks;
                    document.getElementById('current-streak').textContent = stats.currentStreak;
                    document.getElementById('total-minutes-practiced').textContent = stats.totalMinutes;
                    const data = await this.db.getRecentEntries(30);
                    this.updateWeeklyMoodChart(data.moods);
                    this.updateEntriesList(data);
                } catch (e) { console.error(e); }
            }

            updateWeeklyMoodChart(moods) {
                const el = document.getElementById('weekly-mood-chart');
                el.innerHTML = '';
                const emojis = { 'very-low': 'ðŸ˜´', 'low': 'ðŸ˜Œ', 'medium': 'ðŸ˜Š', 'high': 'ðŸ˜®', 'very-high': 'ðŸ˜°' };
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const mood = moods.find(m => m.date === d.toDateString());
                    el.innerHTML += `<div class="mood-day"><div class="mood-emoji">${mood ? emojis[mood.arousalState] : 'Â·'}</div><div class="mood-date">${d.toLocaleDateString('en',{weekday:'short'})}</div></div>`;
                }
            }

            updateEntriesList(data) {
                const el = document.getElementById('entries-list');
                const icons = { breathing: 'â—‹', 'body-check': 'â—‡', mood: 'â—' };
                const all = [
                    ...data.breathing.map(e => ({...e, type:'breathing'})),
                    ...data.bodyChecks.map(e => ({...e, type:'body-check'})),
                    ...data.moods.map(e => ({...e, type:'mood'}))
                ].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (!all.length) {
                    el.innerHTML = '<div class="empty-state"><svg class="empty-state-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg><p>No entries yet. Start with a breathing session or body check-in.</p></div>';
                    return;
                }

                const labels = { 'very-low':'Very Calm','low':'Calm','medium':'Just Right','high':'Energized','very-high':'Overwhelmed' };
                el.innerHTML = all.filter(e => this.currentFilter === 'all' || e.type === this.currentFilter).slice(0, 20).map(e => {
                    const time = new Date(e.timestamp).toLocaleString();
                    let details = '';
                    if (e.type === 'breathing') details = `${e.pattern} Â· ${e.duration||0} min`;
                    else if (e.type === 'body-check') details = `${e.scanType} scan Â· ${(e.sensations||[]).slice(0,3).join(', ')||'No sensations noted'}`;
                    else details = `Feeling: ${labels[e.arousalState]||e.arousalState}`;
                    return `<div class="entry-item"><div class="entry-content"><div class="entry-title">${e.type.charAt(0).toUpperCase()+e.type.slice(1).replace('-',' ')}</div><div class="entry-details">${details}</div></div><div class="entry-time">${time}</div><div class="entry-actions"><button class="entry-action-btn" onclick="app.deleteEntry('${e.type}',${e.id})">Delete</button></div></div>`;
                }).join('');
            }

            setHistoryFilter(filter) {
                this.currentFilter = filter;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
                this.loadHistoryData();
            }

            async deleteEntry(type, id) {
                if (!confirm('Delete this entry?')) return;
                const map = { 'breathing':'breathingSessions','body-check':'bodyCheckIns','mood':'moodEntries' };
                try { await this.db.deleteEntry(map[type], id); this.loadHistoryData(); } catch (e) { alert('Failed to delete.'); }
            }

            async exportData() {
                try {
                    const data = await this.db.exportAllData();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `pumpki-data-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    alert('Data exported successfully.');
                } catch (e) { alert('Export failed.'); }
            }

            async handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                try {
                    const data = JSON.parse(await file.text());
                    if (!data.breathingSessions && !data.bodyCheckIns && !data.moodEntries) throw new Error('Invalid');
                    if (confirm(`Import ${data.breathingSessions?.length||0} breathing, ${data.bodyCheckIns?.length||0} body checks, ${data.moodEntries?.length||0} moods?`)) {
                        const tx = this.db.db.transaction(['breathingSessions','bodyCheckIns','moodEntries'], 'readwrite');
                        for (const s of (data.breathingSessions||[])) { const c = {...s}; delete c.id; tx.objectStore('breathingSessions').add(c); }
                        for (const s of (data.bodyCheckIns||[])) { const c = {...s}; delete c.id; tx.objectStore('bodyCheckIns').add(c); }
                        for (const s of (data.moodEntries||[])) { const c = {...s}; delete c.id; tx.objectStore('moodEntries').add(c); }
                        alert('Data imported successfully.');
                        this.loadHistoryData();
                    }
                } catch (e) { alert('Import failed. Check file format.'); }
                event.target.value = '';
            }

            async clearOldData() {
                if (!confirm('Delete data older than 30 days?')) return;
                try { await this.db.clearOldData(30); this.loadHistoryData(); alert('Old data cleared.'); } catch (e) { alert('Failed.'); }
            }

            // Audio
            async ensureAudioContext() {
                if (!this.audioEnabled) return false;
                if (!this.audioContext) {
                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.masterGain = this.audioContext.createGain();
                        this.masterGain.connect(this.audioContext.destination);
                        this.masterGain.gain.value = 0.3;
                        if (this.audioContext.state === 'suspended') await this.audioContext.resume();
                        return true;
                    } catch (e) { this.audioEnabled = false; return false; }
                }
                return true;
            }

            async playBreathingCue(phase, duration) {
                if (!this.audioEnabled || !await this.ensureAudioContext()) return;
                const freqs = { inhale: 220, hold: 110, exhale: 165, ready: 196 };
                try {
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();
                    osc.connect(gain); gain.connect(this.masterGain);
                    osc.frequency.value = freqs[phase] || 196;
                    osc.type = 'sine';
                    const now = this.audioContext.currentTime;
                    const fade = phase === 'hold' ? 0.3 : 0.1;
                    const vol = phase === 'hold' ? 0.06 : 0.1;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(vol, now + fade);
                    gain.gain.linearRampToValueAtTime(vol, now + duration - fade);
                    gain.gain.linearRampToValueAtTime(0, now + duration);
                    osc.start(now); osc.stop(now + duration);
                    if (phase === 'inhale' || phase === 'exhale') setTimeout(() => this.playTransitionChime(), 100);
                } catch (e) {}
            }

            async playTransitionChime() {
                if (!this.audioEnabled || !await this.ensureAudioContext()) return;
                try {
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();
                    osc.connect(gain); gain.connect(this.masterGain);
                    osc.frequency.value = 440; osc.type = 'sine';
                    const now = this.audioContext.currentTime;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.05, now + 0.05);
                    gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                } catch (e) {}
            }

            async playSuccessSound() {
                if (!this.audioEnabled || !await this.ensureAudioContext()) return;
                [220, 277, 330, 440].forEach((freq, i) => {
                    setTimeout(() => {
                        try {
                            const osc = this.audioContext.createOscillator();
                            const gain = this.audioContext.createGain();
                            osc.connect(gain); gain.connect(this.masterGain);
                            osc.frequency.value = freq; osc.type = 'sine';
                            const now = this.audioContext.currentTime;
                            gain.gain.setValueAtTime(0, now);
                            gain.gain.linearRampToValueAtTime(0.08, now + 0.05);
                            gain.gain.linearRampToValueAtTime(0, now + 0.3);
                            osc.start(now); osc.stop(now + 0.3);
                        } catch (e) {}
                    }, i * 150);
                });
            }

            toggleAudio() {
                this.audioEnabled = !this.audioEnabled;
                const btn = document.getElementById('audio-toggle-btn');
                if (this.audioEnabled) {
                    btn.classList.add('active');
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg> Audio';
                    this.ensureAudioContext().then(ok => { if (ok) this.playSuccessSound(); });
                } else {
                    btn.classList.remove('active');
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg> Muted';
                    if (this.audioContext && this.masterGain) this.masterGain.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + 0.5);
                }
            }

            // Drawing
            drawPumpki() {
                this.ctx.clearRect(0, 0, 400, 400);
                this.ctx.save();
                this.ctx.translate(this.centerX, this.centerY);
                const useScale = !document.body.classList.contains('reduced-motion');
                this.ctx.scale(useScale ? this.breathingScale : 1, useScale ? this.breathingScale : 1);
                this.drawBody();
                this.drawFace();
                this.ctx.restore();
                if (!document.body.classList.contains('reduced-motion')) this.drawSparkles();
            }

            drawBody() {
                this.ctx.save();
                this.ctx.translate(2, 2);
                this.ctx.fillStyle = 'rgba(38, 30, 24, 0.5)';
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 40, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.restore();

                const g = this.ctx.createRadialGradient(-10, -10, 0, 0, 0, 40);
                g.addColorStop(0, '#D4A87E');
                g.addColorStop(1, '#C4956A');
                this.ctx.fillStyle = g;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 40, 0, Math.PI * 2);
                this.ctx.fill();

                this.ctx.fillStyle = '#7A8F65';
                this.ctx.beginPath();
                this.ctx.ellipse(0, -45, 6, 12, 0.1, 0, Math.PI * 2);
                this.ctx.fill();
            }

            drawFace() {
                this.ctx.fillStyle = '#5C4A3C';
                this.ctx.beginPath(); this.ctx.arc(-12, -8, 3, 0, Math.PI); this.ctx.fill();
                this.ctx.beginPath(); this.ctx.arc(12, -8, 3, 0, Math.PI); this.ctx.fill();

                this.ctx.fillStyle = '#A67B52';
                this.ctx.beginPath(); this.ctx.arc(0, 2, 2, 0, Math.PI * 2); this.ctx.fill();

                const useMotion = !document.body.classList.contains('reduced-motion');
                const w = 16 + (this.isBreathing && useMotion ? (this.breathingScale - 1) * 10 : 0);
                this.ctx.strokeStyle = '#5C4A3C';
                this.ctx.lineWidth = 2.5;
                this.ctx.lineCap = 'round';
                this.ctx.beginPath();
                this.ctx.arc(0, 8, w, 0.15, Math.PI - 0.15);
                this.ctx.stroke();

                this.ctx.fillStyle = '#C46A5A';
                this.ctx.globalAlpha = 0.4;
                this.ctx.beginPath(); this.ctx.arc(-25, 5, 6, 0, Math.PI * 2); this.ctx.fill();
                this.ctx.beginPath(); this.ctx.arc(25, 5, 6, 0, Math.PI * 2); this.ctx.fill();
                this.ctx.globalAlpha = 1;
            }

            drawSparkles() {
                const t = this.currentTime * 0.001;
                this.ctx.fillStyle = '#C4A855';
                for (let i = 0; i < 4; i++) {
                    const x = this.centerX + Math.sin(t * 0.5 + i * 1.5) * 70;
                    const y = this.centerY + Math.cos(t * 0.6 + i * 1.2) * 60;
                    const size = 1 + Math.sin(t * 3 + i) * 0.5;
                    this.ctx.globalAlpha = 0.3 + Math.sin(t * 2 + i) * 0.2;
                    this.ctx.save();
                    this.ctx.translate(x, y);
                    this.ctx.rotate(t + i);
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, -size);
                    this.ctx.lineTo(size * 0.3, 0);
                    this.ctx.lineTo(0, size);
                    this.ctx.lineTo(-size * 0.3, 0);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.restore();
                }
                this.ctx.globalAlpha = 1;
            }

            startAnimation() {
                const animate = (t) => { this.currentTime = t; this.drawPumpki(); requestAnimationFrame(animate); };
                requestAnimationFrame(animate);
            }
        }

        let app;
        window.addEventListener('DOMContentLoaded', () => { app = new PumpkiApp(); });
    </script>
</body>
</html>
